<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5, user-scalable=yes">
    <title>Ù…Ù†Ø¯ÙˆØ¨ Ø§Ù„ØªÙˆØµÙŠÙ„ Â· ÙˆÙ‚Øª Ù…ØªØ³Ù„Ø³Ù„ ÙˆØ¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙŠÙˆÙ…</title>
    <style>
        :root {
            --bg-body: #e2f0ff;
            --bg-app: white;
            --header-bg: #0369a1;
            --header-border: #ffb703;
            --text-primary: #01497c;
            --text-secondary: #02315e;
            --card-bg: #f9fcff;
            --card-border: #cde1f5;
            --input-bg: white;
            --input-border: #c7e0ff;
            --stat-bg: #ecf5ff;
            --stat-border: #9ac2e8;
            --btn-outline: #0284c7;
            --btn-outline-hover: #e1f0ff;
            --btn-primary: #0284c7;
            --btn-primary-hover: #0369a1;
            --modal-bg: white;
            --modal-border: #0284c7;
            --shadow: rgba(0, 70, 150, 0.3);
            --order-notes-bg: #fef7e6;
            --order-notes-border: #ffb703;
            --order-time-bg: #dcfce7;
            --order-time-color: #166534;
            --empty-message: #6b8fb0;
            --chart-bg: #f4f9ff;
            --bar-bg: #0284c7;
            --amount-bg: #d1fae5;
            --amount-color: #065f46;
        }

        body.dark-mode {
            --bg-body: #121212;
            --bg-app: #1e1e1e;
            --header-bg: #0f3b5e;
            --header-border: #b45309;
            --text-primary: #90caf9;
            --text-secondary: #e0e0e0;
            --card-bg: #2d2d2d;
            --card-border: #404040;
            --input-bg: #333;
            --input-border: #555;
            --stat-bg: #2a2a2a;
            --stat-border: #555;
            --btn-outline: #90caf9;
            --btn-outline-hover: #2a2a2a;
            --btn-primary: #1e4a6d;
            --btn-primary-hover: #0f3b5e;
            --modal-bg: #2d2d2d;
            --modal-border: #90caf9;
            --shadow: rgba(0,0,0,0.7);
            --order-notes-bg: #3e3a2c;
            --order-notes-border: #b45309;
            --order-time-bg: #1e3a2f;
            --order-time-color: #a7f3d0;
            --empty-message: #9e9e9e;
            --chart-bg: #2a2a2a;
            --bar-bg: #90caf9;
            --amount-bg: #1e3a2f;
            --amount-color: #a7f3d0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, 'Helvetica Neue', sans-serif;
            transition: background-color 0.3s, border-color 0.3s;
        }

        body {
            background: var(--bg-body);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem;
        }

        .app-wrapper {
            max-width: 800px;
            width: 100%;
            background-color: var(--bg-app);
            border-radius: 28px 28px 24px 24px;
            box-shadow: 0 20px 35px -8px var(--shadow);
            overflow: hidden;
            border: 1px solid var(--card-border);
        }

        /* Ø±Ø£Ø³ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ */
        .app-header {
            background: var(--header-bg);
            padding: 1rem 1.2rem;
            display: flex;
            align-items: center;
            gap: 0.8rem;
            color: white;
            border-bottom: 4px solid var(--header-border);
        }

        .icon-placeholder {
            background: rgba(255,255,255,0.25);
            width: 50px;
            height: 50px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid white;
            box-shadow: 0 4px 12px rgba(0, 30, 70, 0.3);
        }

        .icon-placeholder span {
            font-size: 28px;
        }

        .app-header h1 {
            font-size: 1.6rem;
            font-weight: 700;
            text-shadow: 0 2px 5px rgba(0,0,0,0.2);
            flex: 1;
        }

        /* Ø²Ø± Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ */
        .dark-mode-toggle {
            background: rgba(255,255,255,0.2);
            border: 2px solid white;
            color: white;
            width: 44px;
            height: 44px;
            border-radius: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.6rem;
            cursor: pointer;
            transition: 0.2s;
        }
        .dark-mode-toggle:hover {
            background: rgba(255,255,255,0.4);
        }

        /* Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª */
        .stats-bar {
            background: var(--bg-app);
            padding: 0.8rem 1rem;
            display: flex;
            justify-content: space-around;
            border-bottom: 2px solid var(--card-border);
            flex-wrap: wrap;
            gap: 0.4rem;
        }

        .stat-item {
            background: var(--stat-bg);
            padding: 0.3rem 0.8rem;
            border-radius: 30px;
            display: flex;
            align-items: center;
            gap: 0.4rem;
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--text-primary);
            border: 1px solid var(--stat-border);
        }

        .stat-item span {
            background: var(--btn-primary);
            color: white;
            padding: 0.2rem 0.6rem;
            border-radius: 30px;
            font-size: 0.9rem;
        }

        /* Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ø§Ù„Øº ÙˆØ§Ù„ÙˆÙ‚Øª */
        .total-amount, .total-time {
            background: var(--amount-bg);
            color: var(--amount-color);
            padding: 0.3rem 0.8rem;
            border-radius: 30px;
            font-weight: 700;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 0.3rem;
            border: 1px solid var(--amount-color);
        }

        /* Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª */
        .search-section {
            padding: 0.8rem 1rem 0.3rem 1rem;
            background: var(--bg-app);
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            align-items: center;
        }

        .search-row {
            display: flex;
            gap: 0.4rem;
            align-items: center;
            flex: 2 1 260px;
        }

        .search-field {
            flex: 1;
            padding: 0.6rem 1rem;
            border: 2px solid var(--input-border);
            border-radius: 30px;
            font-size: 0.9rem;
            background: var(--input-bg);
            color: var(--text-secondary);
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--btn-outline);
            color: var(--btn-outline);
            padding: 0.5rem 0.9rem;
            border-radius: 30px;
            font-weight: 600;
            font-size: 0.85rem;
            cursor: pointer;
            transition: 0.15s;
            white-space: nowrap;
        }

        .btn-outline:hover {
            background: var(--btn-outline-hover);
        }

        .btn-export {
            background: #0f7b6b;
            border-color: #0b5e4f;
            color: white;
        }
        .btn-export:hover {
            background: #0b5e4f;
        }

        .btn-primary {
            background: var(--btn-primary);
            color: white;
            border-color: var(--btn-primary);
        }
        .btn-primary:hover {
            background: var(--btn-primary-hover);
        }

        /* ÙÙ„ØªØ± Ø§Ù„Ø¹Ø§Ø¬Ù„ */
        .filter-urgent.active {
            background: #dc2626;
            border-color: #b91c1c;
            color: white;
        }

        /* Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª */
        .main-content {
            padding: 0.8rem 1rem 1.2rem 1rem;
            background: var(--bg-app);
        }

        .orders-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 0.3rem 0 0.6rem 0;
            flex-wrap: wrap;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .orders-list {
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
            max-height: 450px;
            overflow-y: auto;
            padding-left: 0.1rem;
        }

        .order-card {
            background: var(--card-bg);
            border-radius: 24px;
            padding: 1rem;
            border: 2px solid var(--card-border);
            box-shadow: 0 4px 8px var(--shadow);
            transition: 0.1s;
            color: var(--text-secondary);
        }

        .order-card.done {
            opacity: 0.6;
            background: var(--stat-bg);
        }

        .order-region-code {
            background: var(--btn-primary);
            color: white;
            border-radius: 30px;
            padding: 0.15rem 0.8rem;
            font-weight: 600;
            font-size: 0.8rem;
            display: inline-block;
            margin-bottom: 0.5rem;
        }

        .order-detail-row {
            display: flex;
            flex-wrap: wrap;
            gap: 0.4rem;
            margin: 0.3rem 0;
        }

        .order-detail-item {
            background: var(--stat-bg);
            padding: 0.2rem 0.8rem;
            border-radius: 20px;
            display: inline-flex;
            align-items: baseline;
            gap: 0.2rem;
            font-size: 0.85rem;
        }

        .order-amount {
            background: var(--amount-bg);
            color: var(--amount-color);
            padding: 0.2rem 0.8rem;
            border-radius: 20px;
            font-weight: 700;
            font-size: 0.85rem;
        }

        .order-notes {
            background: var(--order-notes-bg);
            border-radius: 20px;
            padding: 0.4rem 0.8rem;
            margin: 0.4rem 0;
            border-right: 4px solid var(--order-notes-border);
            font-size: 0.85rem;
        }

        .order-image {
            max-width: 80px;
            max-height: 60px;
            border-radius: 12px;
            margin: 0.4rem 0;
            border: 2px solid var(--btn-outline);
        }

        .order-time {
            background: var(--order-time-bg);
            color: var(--order-time-color);
            border-radius: 20px;
            padding: 0.2rem 0.8rem;
            display: inline-block;
            margin-top: 0.3rem;
            font-size: 0.8rem;
        }

        .order-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.4rem;
            margin-top: 0.6rem;
        }

        .action-btn {
            flex: 1 0 auto;
            background: transparent;
            border: 2px solid var(--btn-outline);
            color: var(--btn-outline);
            border-radius: 30px;
            padding: 0.4rem 0.5rem;
            font-weight: 600;
            font-size: 0.8rem;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 3px;
            min-width: 60px;
        }

        .action-btn.whatsapp {
            background: #25D366;
            border-color: #128C7E;
            color: white;
        }

        .action-btn.call {
            background: #34b7f1;
            border-color: #0284c7;
            color: white;
        }

        .action-btn.done-toggle {
            border-color: #0f7b6b;
            color: #0f7b6b;
        }

        .action-btn.done-toggle input {
            margin-left: 0.2rem;
            transform: scale(1.1);
            accent-color: #0f7b6b;
        }

        .action-btn.edit, .action-btn.delete {
            border-color: #6b7280;
            color: #6b7280;
        }
        .action-btn.delete {
            border-color: #b91c1c;
            color: #b91c1c;
        }

        .empty-message {
            text-align: center;
            color: var(--empty-message);
            padding: 1.5rem;
            background: var(--card-bg);
            border-radius: 40px;
            font-size: 0.9rem;
        }

        /* Ù…ÙˆØ¯Ø§Ù„Ø§Øª */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal.show { display: flex; }

        .modal-content {
            background: var(--modal-bg);
            max-width: 450px;
            width: 90%;
            border-radius: 36px;
            padding: 1.5rem 1.2rem;
            box-shadow: 0 30px 40px var(--shadow);
            border: 3px solid var(--modal-border);
            max-height: 80vh;
            overflow-y: auto;
            color: var(--text-secondary);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .modal-header h2 { 
            color: var(--text-primary); 
            font-size: 1.3rem;
        }
        .close-modal {
            font-size: 1.8rem;
            cursor: pointer;
            color: var(--btn-outline);
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.6rem 0.8rem;
        }
        .full-width { grid-column: span 2; }

        .input-label {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.2rem;
            display: block;
            font-size: 0.9rem;
        }

        .input-field, .input-select, .input-textarea, .input-priority, .input-number {
            width: 100%;
            padding: 0.6rem 1rem;
            border: 2px solid var(--input-border);
            border-radius: 30px;
            background: var(--input-bg);
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        .input-textarea { border-radius: 20px; resize: vertical; min-height: 50px; }
        .file-input { background: var(--input-bg); padding: 0.5rem; }

        .btn-save {
            background: var(--btn-primary);
            color: white;
            border: none;
            padding: 0.8rem 1.2rem;
            border-radius: 40px;
            font-size: 1.1rem;
            font-weight: 700;
            width: 100%;
            cursor: pointer;
            box-shadow: 0 8px 12px -6px var(--btn-primary);
            margin-top: 0.8rem;
        }
        .btn-save:hover { background: var(--btn-primary-hover); }

        /* Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ */
        .region-form {
            display: flex;
            gap: 0.4rem;
            margin-bottom: 1.2rem;
            flex-wrap: wrap;
        }
        .region-form input {
            flex: 1 1 100px;
            padding: 0.6rem;
            border: 2px solid var(--input-border);
            border-radius: 30px;
            background: var(--input-bg);
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        .btn-add {
            background: var(--btn-primary);
            color: white;
            border: none;
            padding: 0.6rem 1.2rem;
            border-radius: 40px;
            font-weight: 600;
            cursor: pointer;
        }

        .items-list {
            list-style: none;
            background: var(--stat-bg);
            border-radius: 24px;
            padding: 0.2rem;
        }
        .item-li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--card-bg);
            margin: 0.4rem 0;
            padding: 0.6rem 1rem;
            border-radius: 40px;
            border: 1px solid var(--card-border);
            font-size: 0.9rem;
        }
        .item-code {
            background: var(--btn-primary);
            color: white;
            padding: 0.15rem 0.6rem;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.8rem;
        }
        .delete-item {
            background: none;
            border: none;
            color: #c00;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0 0.2rem;
        }

        /* Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ */
        .mini-chart {
            display: flex;
            gap: 0.4rem;
            align-items: flex-end;
            height: 50px;
            margin: 0.8rem 1rem;
            padding: 0.4rem;
            background: var(--chart-bg);
            border-radius: 30px;
        }
        .bar {
            flex: 1;
            background: var(--bar-bg);
            border-radius: 15px 15px 6px 6px;
            transition: height 0.3s;
        }

        /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© */
        @media (max-width: 480px) {
            .app-header h1 { font-size: 1.4rem; }
            .icon-placeholder { width: 42px; height: 42px; }
            .icon-placeholder span { font-size: 24px; }
            .dark-mode-toggle { width: 40px; height: 40px; font-size: 1.4rem; }
            .stat-item { font-size: 0.75rem; padding: 0.2rem 0.5rem; }
            .stat-item span { font-size: 0.8rem; padding: 0.1rem 0.5rem; }
            .total-amount, .total-time { font-size: 0.75rem; padding: 0.2rem 0.5rem; }
            .btn-outline { padding: 0.4rem 0.7rem; font-size: 0.75rem; }
            .search-field { padding: 0.5rem 0.8rem; font-size: 0.8rem; }
            .order-card { padding: 0.8rem; }
            .order-detail-item { font-size: 0.75rem; }
            .order-amount { font-size: 0.75rem; }
            .action-btn { font-size: 0.7rem; padding: 0.3rem 0.4rem; }
        }
    </style>
</head>
<body>
    <div class="app-wrapper">
        <!-- Ø±Ø£Ø³ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù…Ø¹ Ø²Ø± Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ -->
        <div class="app-header">
            <div class="icon-placeholder"><span>ğŸ“±</span></div>
            <h1>Ù‡Ù†Ø¯Ø³Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h1>
            <div class="dark-mode-toggle" id="darkModeToggle">ğŸŒ™</div>
        </div>

        <!-- Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
        <div class="stats-bar">
            <div class="stat-item">ğŸ“¦ Ø¥Ø¬Ù…Ø§Ù„ÙŠ <span id="totalOrders">0</span></div>
            <div class="stat-item">âœ… Ù…ÙÙ†Ø¬Ø² <span id="completedOrders">0</span></div>
            <div class="stat-item">â³ Ù…ØªØ¨Ù‚ÙŠ <span id="pendingOrders">0</span></div>
            <div class="stat-item">ğŸ”´ Ø¹Ø§Ø¬Ù„ <span id="urgentOrders">0</span></div>
            <div class="total-amount" id="totalAmount">ğŸ’° 0 Ø±.Ø³</div>
            <div class="total-time" id="totalTime">â±ï¸ 0 Ø¯</div>
        </div>

        <!-- Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª -->
        <div class="search-section">
            <div class="search-row">
                <input type="text" id="searchInput" class="search-field" placeholder="ğŸ” Ø¨Ø­Ø« (Ù…Ù†Ø·Ù‚Ø©ØŒ Ø²Ø¨ÙˆÙ†ØŒ ÙƒÙˆØ¯)">
                <button class="btn-outline" id="manageRegionsBtn">ğŸ—‚ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚</button>
                <button class="btn-outline btn-primary" id="addOrderBtn">â• Ø¥Ø¶Ø§ÙØ©</button>
            </div>
            <div style="display: flex; gap: 0.5rem;">
                <button class="btn-outline" id="filterUrgentBtn">ğŸ”´ Ø¹Ø§Ø¬Ù„ ÙÙ‚Ø·</button>
                <button class="btn-outline btn-export" id="exportExcelBtn">ğŸ“¥ ØªØµØ¯ÙŠØ±</button>
            </div>
        </div>

        <!-- Ø±Ø³Ù… Ø¨ÙŠØ§Ù†ÙŠ Ø¨Ø³ÙŠØ· -->
        <div class="mini-chart">
            <div class="bar" style="height:20px" id="barPending"></div>
            <div class="bar" style="height:20px" id="barCompleted"></div>
            <div class="bar" style="height:20px" id="barUrgent"></div>
        </div>

        <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª -->
        <div class="main-content">
            <div class="orders-header">
                <h3>ğŸšš Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h3>
                <span>(Ù…Ø±ØªØ¨Ø© Ø­Ø³Ø¨ ÙƒÙˆØ¯ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©)</span>
            </div>
            <div class="orders-list" id="ordersList">
                <div class="empty-message">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø¨Ø¹Ø¯</div>
            </div>
        </div>
    </div>

    <!-- Ù…ÙˆØ¯Ø§Ù„ Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ -->
    <div class="modal" id="orderModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>â• Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨</h2>
                <span class="close-modal" id="closeOrderModalBtn">&times;</span>
            </div>
            <form id="orderForm">
                <div class="form-grid">
                    <div class="full-width">
                        <label class="input-label">Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</label>
                        <select id="orderRegion" class="input-select" required>
                            <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†Ø·Ù‚Ø© --</option>
                        </select>
                    </div>
                    <div class="full-width">
                        <label class="input-label">Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†</label>
                        <input type="text" id="customerName" class="input-field" required>
                    </div>
                    <div class="full-width">
                        <label class="input-label">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                        <input type="tel" id="customerPhone" class="input-field" required>
                    </div>
                    <div>
                        <label class="input-label">Ø§Ù„Ù…Ø¨Ù„Øº (Ø¯.Ø¹)</label>
                        <input type="number" id="orderAmount" class="input-number" min="0" step="0.01" required>
                    </div>
                    <div>
                        <label class="input-label">Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©</label>
                        <select id="orderPriority" class="input-priority">
                            <option value="Ø¹Ø§Ø¯ÙŠ">ğŸŸ¡ Ø¹Ø§Ø¯ÙŠ</option>
                            <option value="Ø¹Ø§Ø¬Ù„">ğŸ”´ Ø¹Ø§Ø¬Ù„</option>
                        </select>
                    </div>
                    <div>
                        <label class="input-label">ØµÙˆØ±Ø©</label>
                        <input type="file" id="orderImage" accept="image/*" class="input-field file-input">
                    </div>
                    <div class="full-width">
                        <label class="input-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                        <textarea id="customerNotes" class="input-textarea" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø£Ùˆ Ù…Ù„Ø§Ø­Ø¸Ø§Øª"></textarea>
                    </div>
                </div>
                <button type="submit" class="btn-save">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨</button>
            </form>
        </div>
    </div>

    <!-- Ù…ÙˆØ¯Ø§Ù„ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ -->
    <div class="modal" id="regionModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ğŸ—‚ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚</h2>
                <span class="close-modal" id="closeModalBtn">&times;</span>
            </div>
            <div class="region-form">
                <input type="text" id="regionName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø·Ù‚Ø©">
                <input type="text" id="regionCode" placeholder="ÙƒÙˆØ¯">
                <button class="btn-add" id="addRegionBtn">â•</button>
            </div>
            <ul class="items-list" id="regionsList"></ul>
        </div>
    </div>

    <!-- Ù…ÙˆØ¯Ø§Ù„ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ -->
    <div class="modal" id="editModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨</h2>
                <span class="close-modal" id="closeEditModalBtn">&times;</span>
            </div>
            <form id="editForm">
                <input type="hidden" id="editOrderId">
                <div class="form-grid">
                    <div class="full-width">
                        <label>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</label>
                        <select id="editRegion" class="input-select" required></select>
                    </div>
                    <div class="full-width">
                        <label>Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†</label>
                        <input type="text" id="editCustomerName" class="input-field" required>
                    </div>
                    <div class="full-width">
                        <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                        <input type="tel" id="editCustomerPhone" class="input-field" required>
                    </div>
                    <div>
                        <label>Ø§Ù„Ù…Ø¨Ù„Øº</label>
                        <input type="number" id="editAmount" class="input-number" min="0" step="0.01" required>
                    </div>
                    <div>
                        <label>Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©</label>
                        <select id="editPriority" class="input-priority">
                            <option value="Ø¹Ø§Ø¯ÙŠ">ğŸŸ¡ Ø¹Ø§Ø¯ÙŠ</option>
                            <option value="Ø¹Ø§Ø¬Ù„">ğŸ”´ Ø¹Ø§Ø¬Ù„</option>
                        </select>
                    </div>
                    <div class="full-width">
                        <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                        <textarea id="editNotes" class="input-textarea"></textarea>
                    </div>
                </div>
                <button type="submit" class="btn-save">ğŸ’¾ Ø­ÙØ¸</button>
            </form>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        (function() {
            'use strict';

            // Ù…ÙØ§ØªÙŠØ­ localStorage
            const REGIONS_KEY = 'delivery_regions_pro';
            const ORDERS_KEY = 'delivery_orders_pro_v7';
            const DARK_MODE_KEY = 'dark_mode';

            // Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            let regions = [];
            let orders = [];

            // Ø­Ø§Ù„Ø© Ø§Ù„ÙÙ„ØªØ±
            let showUrgentOnly = false;

            // Ø¹Ù†Ø§ØµØ± DOM
            const regionSelect = document.getElementById('orderRegion');
            const ordersListDiv = document.getElementById('ordersList');
            const totalSpan = document.getElementById('totalOrders');
            const completedSpan = document.getElementById('completedOrders');
            const pendingSpan = document.getElementById('pendingOrders');
            const urgentSpan = document.getElementById('urgentOrders');
            const totalAmountSpan = document.getElementById('totalAmount');
            const totalTimeSpan = document.getElementById('totalTime');
            const searchInput = document.getElementById('searchInput');
            const manageRegionsBtn = document.getElementById('manageRegionsBtn');
            const addOrderBtn = document.getElementById('addOrderBtn');
            const filterUrgentBtn = document.getElementById('filterUrgentBtn');
            const regionModal = document.getElementById('regionModal');
            const orderModal = document.getElementById('orderModal');
            const editModal = document.getElementById('editModal');
            const closeModalBtn = document.getElementById('closeModalBtn');
            const closeOrderModalBtn = document.getElementById('closeOrderModalBtn');
            const closeEditModalBtn = document.getElementById('closeEditModalBtn');
            const regionsListUl = document.getElementById('regionsList');
            const addRegionBtn = document.getElementById('addRegionBtn');
            const regionNameInput = document.getElementById('regionName');
            const regionCodeInput = document.getElementById('regionCode');
            const exportBtn = document.getElementById('exportExcelBtn');
            const darkModeToggle = document.getElementById('darkModeToggle');

            // Ø¹Ù†Ø§ØµØ± Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø·Ù„Ø¨
            const orderForm = document.getElementById('orderForm');
            const customerNameInput = document.getElementById('customerName');
            const customerPhoneInput = document.getElementById('customerPhone');
            const customerNotesInput = document.getElementById('customerNotes');
            const orderPriorityInput = document.getElementById('orderPriority');
            const orderAmountInput = document.getElementById('orderAmount');
            const orderImageInput = document.getElementById('orderImage');

            // Ø¹Ù†Ø§ØµØ± Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
            const editForm = document.getElementById('editForm');
            const editOrderId = document.getElementById('editOrderId');
            const editRegion = document.getElementById('editRegion');
            const editCustomerName = document.getElementById('editCustomerName');
            const editCustomerPhone = document.getElementById('editCustomerPhone');
            const editAmount = document.getElementById('editAmount');
            const editPriority = document.getElementById('editPriority');
            const editNotes = document.getElementById('editNotes');

            // ===== Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ =====
            function loadDarkMode() {
                const dark = localStorage.getItem(DARK_MODE_KEY) === 'true';
                if (dark) {
                    document.body.classList.add('dark-mode');
                    darkModeToggle.textContent = 'â˜€ï¸';
                } else {
                    document.body.classList.remove('dark-mode');
                    darkModeToggle.textContent = 'ğŸŒ™';
                }
            }
            function toggleDarkMode() {
                document.body.classList.toggle('dark-mode');
                const isDark = document.body.classList.contains('dark-mode');
                localStorage.setItem(DARK_MODE_KEY, isDark);
                darkModeToggle.textContent = isDark ? 'â˜€ï¸' : 'ğŸŒ™';
            }
            darkModeToggle.addEventListener('click', toggleDarkMode);
            loadDarkMode();

            // ===== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª =====
            function loadRegions() {
                try {
                    const stored = localStorage.getItem(REGIONS_KEY);
                    regions = stored ? JSON.parse(stored) : [];
                    if (!Array.isArray(regions)) regions = [];
                } catch { regions = []; }
                regions.sort((a, b) => (Number(a.code) || a.code) - (Number(b.code) || b.code));
            }
            function loadOrders() {
                try {
                    const stored = localStorage.getItem(ORDERS_KEY);
                    orders = stored ? JSON.parse(stored) : [];
                    if (!Array.isArray(orders)) orders = [];
                } catch { orders = []; }
            }
            function saveRegions() { localStorage.setItem(REGIONS_KEY, JSON.stringify(regions)); }
            function saveOrders() { localStorage.setItem(ORDERS_KEY, JSON.stringify(orders)); }

            // ===== ØªØ­Ø¯ÙŠØ« Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ =====
            function populateRegionSelect(targetSelect = regionSelect) {
                targetSelect.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†Ø·Ù‚Ø© --</option>';
                regions.forEach(r => {
                    const option = document.createElement('option');
                    option.value = r.id;
                    option.textContent = `${r.name} (ÙƒÙˆØ¯ ${r.code})`;
                    targetSelect.appendChild(option);
                });
            }

            // ===== Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ ÙÙŠ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ =====
            function renderRegionsList() {
                regionsListUl.innerHTML = '';
                if (regions.length === 0) {
                    regionsListUl.innerHTML = '<li style="text-align:center; padding:1rem;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†Ø§Ø·Ù‚ Ø¨Ø¹Ø¯</li>';
                    return;
                }
                regions.forEach((region, index) => {
                    const li = document.createElement('li');
                    li.className = 'item-li';
                    li.innerHTML = `
                        <span><strong>${escapeHTML(region.name)}</strong> <span class="item-code">${escapeHTML(region.code)}</span></span>
                        <button class="delete-item" data-index="${index}">ğŸ—‘</button>
                    `;
                    regionsListUl.appendChild(li);
                });
                document.querySelectorAll('.delete-item').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        const idx = btn.getAttribute('data-index');
                        if (idx !== null) {
                            const regionId = regions[idx]?.id;
                            if (orders.some(o => o.regionId === regionId)) {
                                alert('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ù„Ø£Ù† Ù‡Ù†Ø§Ùƒ Ø·Ù„Ø¨Ø§Øª Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø§.');
                                return;
                            }
                            regions.splice(idx, 1);
                            saveRegions();
                            loadRegions();
                            renderRegionsList();
                            populateRegionSelect();
                            renderOrders();
                        }
                    });
                });
            }

            // ===== Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø·Ù‚Ø© =====
            function addRegion() {
                const name = regionNameInput.value.trim();
                const code = regionCodeInput.value.trim();
                if (!name || !code) return alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„ÙƒÙˆØ¯');
                if (regions.some(r => r.code === code)) return alert('Ø§Ù„ÙƒÙˆØ¯ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¨Ù‚Ø§Ù‹');
                regions.push({ id: 'r_' + Date.now() + Math.random().toString(36).substr(2,5), name, code });
                saveRegions();
                loadRegions();
                regionNameInput.value = '';
                regionCodeInput.value = '';
                renderRegionsList();
                populateRegionSelect();
            }

            // ===== Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ =====
            function addOrder(event) {
                event.preventDefault();
                const regionId = regionSelect.value;
                const customerName = customerNameInput.value.trim();
                const customerPhone = customerPhoneInput.value.trim();
                const customerNotes = customerNotesInput.value.trim();
                const priority = orderPriorityInput.value;
                const amount = parseFloat(orderAmountInput.value);
                const imageFile = orderImageInput.files[0];

                if (!regionId || !customerName || !customerPhone || isNaN(amount)) {
                    alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù†Ø·Ù‚Ø© ÙˆØ¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ† ÙˆØ±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ÙˆØ§Ù„Ù…Ø¨Ù„Øº');
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    const now = Date.now();
                    const newOrder = {
                        id: 'o_' + Date.now() + Math.random().toString(36).substr(2,5),
                        regionId,
                        customerName,
                        customerPhone,
                        customerNotes,
                        priority,
                        amount: amount,
                        image: e.target.result || null,
                        done: false,
                        startTime: now,
                        endTime: null,
                        duration: null
                    };
                    orders.push(newOrder);
                    saveOrders();

                    customerNameInput.value = '';
                    customerPhoneInput.value = '';
                    customerNotesInput.value = '';
                    orderAmountInput.value = '';
                    orderImageInput.value = '';
                    orderModal.classList.remove('show');
                    renderOrders();
                };
                if (imageFile) {
                    reader.readAsDataURL(imageFile);
                } else {
                    reader.onload({ target: { result: null } });
                }
            }

            // ===== ØªØ±ØªÙŠØ¨ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø­Ø³Ø¨ ÙƒÙˆØ¯ Ø§Ù„Ù…Ù†Ø·Ù‚Ø© =====
            function getSortedOrders() {
                const regionMap = Object.fromEntries(regions.map(r => [r.id, r]));
                return [...orders].sort((a, b) => {
                    const codeA = regionMap[a.regionId]?.code || '';
                    const codeB = regionMap[b.regionId]?.code || '';
                    return (Number(codeA) || codeA) - (Number(codeB) || codeB);
                });
            }

            // ===== ØªØ¨Ø¯ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ù†Ø¬Ø§Ø² Ù…Ø¹ Ù…Ù†Ø·Ù‚ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ³Ù„Ø³Ù„ =====
            function toggleDone(orderId, checked) {
                const order = orders.find(o => o.id === orderId);
                if (!order) return;

                if (checked) {
                    const now = Date.now();
                    order.endTime = now;
                    order.duration = now - order.startTime;
                    order.done = true;

                    const sorted = getSortedOrders();
                    const currentIndex = sorted.findIndex(o => o.id === orderId);
                    if (currentIndex !== -1) {
                        for (let i = currentIndex + 1; i < sorted.length; i++) {
                            const next = sorted[i];
                            if (!next.done) {
                                next.startTime = now;
                                break;
                            }
                        }
                    }
                } else {
                    order.endTime = null;
                    order.duration = null;
                    order.done = false;
                }

                saveOrders();
                renderOrders();
            }

            // ===== Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù…Ø¹ Ø§Ù„ÙÙ„ØªØ±Ø© =====
            function renderOrders() {
                const regionMap = Object.fromEntries(regions.map(r => [r.id, r]));

                const sorted = getSortedOrders();

                const searchTerm = searchInput.value.trim().toLowerCase();
                let filtered = sorted;
                if (searchTerm) {
                    filtered = sorted.filter(o => {
                        const region = regionMap[o.regionId];
                        return (region?.name?.toLowerCase().includes(searchTerm) ||
                                region?.code?.toLowerCase().includes(searchTerm) ||
                                o.customerName.toLowerCase().includes(searchTerm) ||
                                o.customerPhone.includes(searchTerm));
                    });
                }

                if (showUrgentOnly) {
                    filtered = filtered.filter(o => o.priority === 'Ø¹Ø§Ø¬Ù„');
                }

                if (!filtered.length) {
                    ordersListDiv.innerHTML = '<div class="empty-message">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div>';
                    updateStats();
                    return;
                }

                let html = '';
                filtered.forEach(order => {
                    const region = regionMap[order.regionId] || { name: 'Ù…Ù†Ø·Ù‚Ø© Ù…Ø­Ø°ÙˆÙØ©', code: '?' };
                    const doneClass = order.done ? 'done' : '';
                    const phoneClean = order.customerPhone.replace(/\s+/g, '');
                    const waMessage = encodeURIComponent(`Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ…ØŒ Ø·Ù„Ø¨Ùƒ Ù…Ù† Ù…Ù†Ø·Ù‚Ø© ${region.name} (ÙƒÙˆØ¯ ${region.code})ØŒ Ø§Ù„Ø²Ø¨ÙˆÙ†: ${order.customerName}. Ø§Ù„Ù…Ø¨Ù„Øº: ${order.amount} Ø±.Ø³. Ù…Ù„Ø§Ø­Ø¸Ø§Øª: ${order.customerNotes || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}`);
                    const waLink = phoneClean ? `https://wa.me/${phoneClean}?text=${waMessage}` : '#';
                    const telLink = phoneClean ? `tel:${phoneClean}` : '#';

                    let timeText = '';
                    if (order.done && order.duration) {
                        const minutes = Math.floor(order.duration / 60000);
                        const seconds = Math.floor((order.duration % 60000) / 1000);
                        timeText = `â±ï¸ Ø§Ø³ØªØºØ±Ù‚: ${minutes} Ø¯ ${seconds} Ø«`;
                    } else if (!order.done && order.startTime) {
                        const elapsed = Date.now() - order.startTime;
                        const minutes = Math.floor(elapsed / 60000);
                        const seconds = Math.floor((elapsed % 60000) / 1000);
                        timeText = `â³ Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°: ${minutes} Ø¯ ${seconds} Ø«`;
                    }

                    html += `
                        <div class="order-card ${doneClass}" data-order-id="${order.id}">
                            <div class="order-region-code">${escapeHTML(region.name)} Â· ÙƒÙˆØ¯ ${escapeHTML(region.code)}</div>
                            <div class="order-detail-row">
                                <div class="order-detail-item"><strong>Ø§Ù„Ø²Ø¨ÙˆÙ†:</strong> <span>${escapeHTML(order.customerName)}</span></div>
                                <div class="order-detail-item"><strong>Ø§Ù„Ù‡Ø§ØªÙ:</strong> <span dir="ltr">${escapeHTML(order.customerPhone)}</span></div>
                                <div class="order-detail-item"><strong>Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©:</strong> <span>${order.priority === 'Ø¹Ø§Ø¬Ù„' ? 'ğŸ”´ Ø¹Ø§Ø¬Ù„' : 'ğŸŸ¡ Ø¹Ø§Ø¯ÙŠ'}</span></div>
                                <div class="order-amount"><strong>ğŸ’°</strong> ${order.amount} Ø±.Ø³</div>
                            </div>
                            ${order.customerNotes ? `<div class="order-notes">ğŸ“ ${escapeHTML(order.customerNotes)}</div>` : ''}
                            ${order.image ? `<img src="${order.image}" class="order-image" alt="ØµÙˆØ±Ø© Ø§Ù„Ø·Ù„Ø¨">` : ''}
                            ${timeText ? `<div class="order-time">${timeText}</div>` : ''}
                            <div class="order-actions">
                                <a class="action-btn call" href="${telLink}" target="_blank">ğŸ“ Ø§ØªØµØ§Ù„</a>
                                <a class="action-btn whatsapp" href="${waLink}" target="_blank">ğŸ“± ÙˆØ§ØªØ³Ø§Ø¨</a>
                                <label class="action-btn done-toggle">
                                    <input type="checkbox" class="done-checkbox" data-id="${order.id}" ${order.done ? 'checked' : ''}> ØªÙ…
                                </label>
                                <button class="action-btn edit" data-id="${order.id}">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
                                <button class="action-btn delete" data-id="${order.id}">ğŸ—‘ Ø­Ø°Ù</button>
                            </div>
                        </div>
                    `;
                });

                ordersListDiv.innerHTML = html;

                document.querySelectorAll('.done-checkbox').forEach(cb => {
                    cb.addEventListener('change', function(e) {
                        e.preventDefault();
                        toggleDone(this.getAttribute('data-id'), this.checked);
                    });
                });

                document.querySelectorAll('.action-btn.edit').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const orderId = btn.getAttribute('data-id');
                        const order = orders.find(o => o.id === orderId);
                        if (order) openEditModal(order);
                    });
                });

                document.querySelectorAll('.action-btn.delete').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const orderId = btn.getAttribute('data-id');
                        if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ØŸ')) {
                            orders = orders.filter(o => o.id !== orderId);
                            saveOrders();
                            renderOrders();
                        }
                    });
                });

                updateStats();
                updateChart();
            }

            // ===== ÙØªØ­ Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ =====
            function openEditModal(order) {
                editOrderId.value = order.id;
                populateRegionSelect(editRegion);
                editRegion.value = order.regionId;
                editCustomerName.value = order.customerName;
                editCustomerPhone.value = order.customerPhone;
                editAmount.value = order.amount;
                editPriority.value = order.priority || 'Ø¹Ø§Ø¯ÙŠ';
                editNotes.value = order.customerNotes || '';
                editModal.classList.add('show');
            }

            // ===== Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ =====
            function handleEditSubmit(e) {
                e.preventDefault();
                const id = editOrderId.value;
                const order = orders.find(o => o.id === id);
                if (!order) return;

                order.regionId = editRegion.value;
                order.customerName = editCustomerName.value.trim();
                order.customerPhone = editCustomerPhone.value.trim();
                order.amount = parseFloat(editAmount.value);
                order.priority = editPriority.value;
                order.customerNotes = editNotes.value.trim();

                saveOrders();
                editModal.classList.remove('show');
                renderOrders();
            }

            // ===== ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª =====
            function updateStats() {
                const total = orders.length;
                const completed = orders.filter(o => o.done).length;
                const pending = total - completed;
                const urgent = orders.filter(o => o.priority === 'Ø¹Ø§Ø¬Ù„' && !o.done).length;
                const totalAmount = orders.filter(o => o.done).reduce((sum, o) => sum + (o.amount || 0), 0);
                
                const totalMinutes = orders
                    .filter(o => o.done && o.duration)
                    .reduce((sum, o) => sum + o.duration, 0) / 60000;
                
                totalSpan.textContent = total;
                completedSpan.textContent = completed;
                pendingSpan.textContent = pending;
                urgentSpan.textContent = urgent;
                totalAmountSpan.innerHTML = `ğŸ’° ${totalAmount.toFixed(2)} Ø±.Ø³`;
                totalTimeSpan.innerHTML = `â±ï¸ ${totalMinutes.toFixed(1)} Ø¯`;
            }

            // ===== ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ =====
            function updateChart() {
                const total = orders.length || 1;
                const pending = orders.filter(o => !o.done).length;
                const completed = orders.filter(o => o.done).length;
                const urgent = orders.filter(o => o.priority === 'Ø¹Ø§Ø¬Ù„' && !o.done).length;

                document.getElementById('barPending').style.height = (pending / total * 45) + 'px';
                document.getElementById('barCompleted').style.height = (completed / total * 45) + 'px';
                document.getElementById('barUrgent').style.height = (urgent / total * 45) + 'px';
            }

            // ===== ØªØµØ¯ÙŠØ± Excel =====
            function exportToExcel() {
                const regionMap = Object.fromEntries(regions.map(r => [r.id, r]));
                const data = orders.map(o => {
                    const duration = o.duration ? (o.duration / 60000).toFixed(2) + ' Ø¯Ù‚ÙŠÙ‚Ø©' : 'Ù„Ù… ÙŠÙƒØªÙ…Ù„';
                    return {
                        Ø§Ù„Ù…Ù†Ø·Ù‚Ø©: regionMap[o.regionId]?.name || '',
                        'ÙƒÙˆØ¯ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©': regionMap[o.regionId]?.code || '',
                        Ø§Ù„Ø²Ø¨ÙˆÙ†: o.customerName,
                        Ø§Ù„Ù‡Ø§ØªÙ: o.customerPhone,
                        Ø§Ù„Ù…Ø¨Ù„Øº: o.amount,
                        Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©: o.priority,
                        Ù…Ù„Ø§Ø­Ø¸Ø§Øª: o.customerNotes,
                        'ÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø¡': new Date(o.startTime).toLocaleString('ar-EG'),
                        'ÙˆÙ‚Øª Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡': o.endTime ? new Date(o.endTime).toLocaleString('ar-EG') : '',
                        'Ø§Ù„Ù…Ø¯Ø© (Ø¯Ù‚ÙŠÙ‚Ø©)': o.duration ? (o.duration / 60000).toFixed(2) : '',
                        ØªÙ…: o.done ? 'Ù†Ø¹Ù…' : 'Ù„Ø§'
                    };
                });
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Ø§Ù„Ø·Ù„Ø¨Ø§Øª');
                XLSX.writeFile(wb, 'Ø·Ù„Ø¨Ø§Øª_Ù…Ù†Ø¯ÙˆØ¨_Ù…Ø¹_Ø§Ù„ÙˆÙ‚Øª_Ø§Ù„Ù…ØªØ³Ù„Ø³Ù„.xlsx');
            }

            // ===== Ù…Ø³Ø§Ø¹Ø¯ HTML escape =====
            function escapeHTML(str) {
                if (!str) return '';
                return String(str).replace(/[&<>"]/g, function(m) {
                    if (m === '&') return '&amp;';
                    if (m === '<') return '&lt;';
                    if (m === '>') return '&gt;';
                    if (m === '"') return '&quot;';
                    return m;
                });
            }

            // ===== Ø£Ø­Ø¯Ø§Ø« =====
            searchInput.addEventListener('input', renderOrders);

            filterUrgentBtn.addEventListener('click', () => {
                showUrgentOnly = !showUrgentOnly;
                filterUrgentBtn.classList.toggle('active', showUrgentOnly);
                renderOrders();
            });

            manageRegionsBtn.addEventListener('click', () => {
                renderRegionsList();
                regionModal.classList.add('show');
            });
            closeModalBtn.addEventListener('click', () => regionModal.classList.remove('show'));
            window.addEventListener('click', (e) => { if (e.target === regionModal) regionModal.classList.remove('show'); });

            addOrderBtn.addEventListener('click', () => {
                populateRegionSelect(regionSelect);
                orderModal.classList.add('show');
            });
            closeOrderModalBtn.addEventListener('click', () => orderModal.classList.remove('show'));
            window.addEventListener('click', (e) => { if (e.target === orderModal) orderModal.classList.remove('show'); });

            addRegionBtn.addEventListener('click', (e) => { e.preventDefault(); addRegion(); });

            orderForm.addEventListener('submit', addOrder);

            exportBtn.addEventListener('click', exportToExcel);

            editForm.addEventListener('submit', handleEditSubmit);
            closeEditModalBtn.addEventListener('click', () => editModal.classList.remove('show'));
            window.addEventListener('click', (e) => { if (e.target === editModal) editModal.classList.remove('show'); });

            // ===== ØªÙ‡ÙŠØ¦Ø© =====
            loadRegions();
            loadOrders();
            populateRegionSelect();
            renderOrders();

            setInterval(renderOrders, 1000);
        })();
    </script>
</body>
</html>
